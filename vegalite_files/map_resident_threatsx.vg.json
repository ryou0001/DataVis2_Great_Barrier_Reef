{
"$schema": "https://vega.github.io/schema/vega-lite/v5.json",
"data": {"url": "vegalite_files/data/resident_threatsx.csv"},
"concat": [{
"vconcat": 
[
    {
        "hconcat": [
    {
        "width": 303,
        "height": 360,
        "title": { "text": "Climate Change" },
        "projection": {"type": "mercator"},
        "view": {"fill": "white"},
        "layer": [
            {
            "data": {
                "name": "GBR_boundary",
                "url": "vegalite_files/maps/GBR_boundary.json",
                "format": {"type": "topojson", "feature": "GBR_boundary"}
            },
            "mark": {"type": "geoshape", "fill": "lightgray", "opacity": 0.5}
            },
            {
                "data": {
                    "url": "vegalite_files/maps/queensland_surrounds.json",
                    "format": {"type": "topojson", "feature": "ne_10m_admin_1_states_provinces"}
                },
                "mark": {"type": "geoshape", "fill": "lightgray", "stroke": "darkgray"}
            },
            {
                "data": {
                    "url": "vegalite_files/maps/queensland.json",
                    "format": {"type": "topojson", "feature": "ne_10m_admin_1_states_provinces"}
                },
                "mark": {"type": "geoshape", "fill": "white", "stroke": "darkgray"}
            },
            {
                "data": {
                    "url": "vegalite_files/maps/NRM_regions_2020.json",
                    "format": {"type": "topojson", "feature": "NRM_regions_2020"}
                },
                "transform": [
                {
                    "calculate": "datum.properties.NRM_REGION+'1'", "as": "combined_key"    
                },{
                    "lookup": "combined_key",
                    "from": {
                        "data": {"url": "vegalite_files/data/resident_threatsx.csv"},
                        "key": "NRM_key",
                        "fields": ["NRM", "population", "total_interviewed", "threat", "threat_total"]
                    }
                },{
                    "calculate": "datum.threat_total/datum.total_interviewed",
                    "as": "threat_perc"
                },{
                    "calculate": "datum.total_interviewed < 10 ? 'Insufficient data' : format(datum.threat_perc, '.2%')",
                    "as": "tooltip_threat_perc"
                },{
                    "calculate": "datum.total_interviewed < 10 ? 'Insufficient data' : datum.threat_total",
                    "as": "tooltip_threat_total"
                }],
                "mark": {
                    "type": "geoshape", 
                    "stroke": "darkgray",
                    "opacity": 0.6
                },
                "encoding": {
                    "opacity": {
                    "condition": {
                        "test": "bar == null || datum.threat == bar.threat && datum.properties.NRM_REGION == bar.NRM",
                        "value": 1
                    }
                    },
                    "color": {
                        "condition": {
                            "test": "datum.threat_perc == 0",
                            "value": "lightgrey"
                        },
                        "field": "threat_perc",
                        "type": "quantitative",
                        "scale": {
                            "domain": [0,0.45], "scheme": {"name": "reds"}
                        },
                    "legend": {
                        "title": "% of residents",
                        "format": ".0%"
                    }
                    },
                    "tooltip": [
                        {"field": "properties.NRM_REGION", "type": "nominal", "title": "NRM Region"},
                        {"field": "tooltip_threat_total", "title": "Num. interviewed residents concerned about threat"},
                        {"field": "tooltip_threat_perc", "title": "Perc. interviewed residents concerned about threat"}
                    ]
                }
            },{
            "data": {"values": {"state": "QUEENSLAND", "x": 146, "y": -27.5}},
            "mark": {"type": "text", "fontSize": 20, "color": "darkgray"},
            "encoding": {
                "text": {"field": "state", "type": "nominal"},
                "longitude": {"field": "x"}, 
                "latitude": {"field": "y"}}
            }
        ]
    },{
        "width": 303,
        "height": 360,
        "title": { "text": "Coral Bleaching" },
        "projection": {"type": "mercator"},
        "view": {"fill": "white"},
        "layer": [
            {
            "data": {
                "name": "GBR_boundary",
                "url": "vegalite_files/maps/GBR_boundary.json",
                "format": {"type": "topojson", "feature": "GBR_boundary"}
            },
            "mark": {"type": "geoshape", "fill": "lightgray", "opacity": 0.5}
            },
            {
                "data": {
                    "url": "vegalite_files/maps/queensland_surrounds.json",
                    "format": {"type": "topojson", "feature": "ne_10m_admin_1_states_provinces"}
                },
                "mark": {"type": "geoshape", "fill": "lightgray", "stroke": "darkgray"}
            },
            {
                "data": {
                    "url": "vegalite_files/maps/queensland.json",
                    "format": {"type": "topojson", "feature": "ne_10m_admin_1_states_provinces"}
                },
                "mark": {"type": "geoshape", "fill": "white", "stroke": "darkgray"}
            },
            {
                "data": {
                    "url": "vegalite_files/maps/NRM_regions_2020.json",
                    "format": {"type": "topojson", "feature": "NRM_regions_2020"}
                },
                "transform": [
                {
                    "calculate": "datum.properties.NRM_REGION+'2'", "as": "combined_key"    
                },{
                    "lookup": "combined_key",
                    "from": {
                        "data": {"url": "vegalite_files/data/resident_threatsx.csv"},
                        "key": "NRM_key",
                        "fields": ["NRM", "population", "total_interviewed", "threat", "threat_total"]
                    }
                },{
                    "calculate": "datum.threat_total/datum.total_interviewed",
                    "as": "threat_perc"
                },{
                    "calculate": "datum.total_interviewed < 10 ? 'Insufficient data' : format(datum.threat_perc, '.2%')",
                    "as": "tooltip_threat_perc"
                },{
                    "calculate": "datum.total_interviewed < 10 ? 'Insufficient data' : datum.threat_total",
                    "as": "tooltip_threat_total"
                }],
                "mark": {
                    "type": "geoshape", 
                    "stroke": "darkgray",
                    "opacity": 0.6
                },
                "encoding": {
                    "opacity": {
                    },
                    "color": {
                        "condition": {
                            "test": "datum.threat_perc == 0",
                            "value": "lightgrey"
                        },
                        "field": "threat_perc",
                        "type": "quantitative",
                        "scale": {
                            "domain": [0,0.45], "scheme": {"name": "reds"}
                        },
                    "legend": {
                        "title": "% of residents",
                        "format": ".0%"
                    }
                    },
                    "tooltip": [
                        {"field": "properties.NRM_REGION", "type": "nominal", "title": "NRM Region"},
                        {"field": "tooltip_threat_total", "title": "Num. interviewed residents concerned about threat"},
                        {"field": "tooltip_threat_perc", "title": "Perc. interviewed residents concerned about threat"}
                    ]
                }
            },{
            "data": {"values": {"state": "QUEENSLAND", "x": 146, "y": -27.5}},
            "mark": {"type": "text", "fontSize": 20, "color": "darkgray"},
            "encoding": {
                "text": {"field": "state", "type": "nominal"},
                "longitude": {"field": "x"}, 
                "latitude": {"field": "y"}}
            }
        ]
    }]},
    {"hconcat": [
        {
        "width": 303,
        "height": 360,
        "title": { "text": "Mining" },
        "projection": {"type": "mercator"},
        "view": {"fill": "white"},
        "layer": [
            {
            "data": {
                "name": "GBR_boundary",
                "url": "vegalite_files/maps/GBR_boundary.json",
                "format": {"type": "topojson", "feature": "GBR_boundary"}
            },
            "mark": {"type": "geoshape", "fill": "lightgray", "opacity": 0.5}
            },
            {
                "data": {
                    "url": "vegalite_files/maps/queensland_surrounds.json",
                    "format": {"type": "topojson", "feature": "ne_10m_admin_1_states_provinces"}
                },
                "mark": {"type": "geoshape", "fill": "lightgray", "stroke": "darkgray"}
            },
            {
                "data": {
                    "url": "vegalite_files/maps/queensland.json",
                    "format": {"type": "topojson", "feature": "ne_10m_admin_1_states_provinces"}
                },
                "mark": {"type": "geoshape", "fill": "white", "stroke": "darkgray"}
            },
            {
                "data": {
                    "url": "vegalite_files/maps/NRM_regions_2020.json",
                    "format": {"type": "topojson", "feature": "NRM_regions_2020"}
                },
                "transform": [
                {
                    "calculate": "datum.properties.NRM_REGION+'3'", "as": "combined_key"    
                },{
                    "lookup": "combined_key",
                    "from": {
                        "data": {"url": "vegalite_files/data/resident_threatsx.csv"},
                        "key": "NRM_key",
                        "fields": ["NRM", "population", "total_interviewed", "threat", "threat_total"]
                    }
                },{
                    "calculate": "datum.threat_total/datum.total_interviewed",
                    "as": "threat_perc"
                },{
                    "calculate": "datum.total_interviewed < 10 ? 'Insufficient data' : format(datum.threat_perc, '.2%')",
                    "as": "tooltip_threat_perc"
                },{
                    "calculate": "datum.total_interviewed < 10 ? 'Insufficient data' : datum.threat_total",
                    "as": "tooltip_threat_total"
                }],
                "mark": {
                    "type": "geoshape", 
                    "stroke": "darkgray",
                    "opacity": 0.6
                },
                "encoding": {
                    "opacity": {
                    },
                    "color": {
                        "condition": {
                            "test": "datum.threat_perc == 0",
                            "value": "lightgrey"
                        },
                        "field": "threat_perc",
                        "type": "quantitative",
                        "scale": {
                            "domain": [0,0.45], "scheme": {"name": "reds"}
                        },
                    "legend": {
                        "title": "% of residents",
                        "format": ".0%"
                    }
                    },
                    "tooltip": [
                        {"field": "properties.NRM_REGION", "type": "nominal", "title": "NRM Region"},
                        {"field": "tooltip_threat_total", "title": "Num. interviewed residents concerned about threat"},
                        {"field": "tooltip_threat_perc", "title": "Perc. interviewed residents concerned about threat"}
                    ]
                }
            },{
            "data": {"values": {"state": "QUEENSLAND", "x": 146, "y": -27.5}},
            "mark": {"type": "text", "fontSize": 20, "color": "darkgray"},
            "encoding": {
                "text": {"field": "state", "type": "nominal"},
                "longitude": {"field": "x"}, 
                "latitude": {"field": "y"}}
            }
        ]
    },{
        "width": 303,
        "height": 360,
        "title": { "text": "Tourism" },
        "projection": {"type": "mercator"},
        "view": {"fill": "white"},
        "layer": [
            {
            "data": {
                "name": "GBR_boundary",
                "url": "vegalite_files/maps/GBR_boundary.json",
                "format": {"type": "topojson", "feature": "GBR_boundary"}
            },
            "mark": {"type": "geoshape", "fill": "lightgray", "opacity": 0.5}
            },
            {
                "data": {
                    "url": "vegalite_files/maps/queensland_surrounds.json",
                    "format": {"type": "topojson", "feature": "ne_10m_admin_1_states_provinces"}
                },
                "mark": {"type": "geoshape", "fill": "lightgray", "stroke": "darkgray"}
            },
            {
                "data": {
                    "url": "vegalite_files/maps/queensland.json",
                    "format": {"type": "topojson", "feature": "ne_10m_admin_1_states_provinces"}
                },
                "mark": {"type": "geoshape", "fill": "white", "stroke": "darkgray"}
            },
            {
                "data": {
                    "url": "vegalite_files/maps/NRM_regions_2020.json",
                    "format": {"type": "topojson", "feature": "NRM_regions_2020"}
                },
                "transform": [
                {
                    "calculate": "datum.properties.NRM_REGION+'4'", "as": "combined_key"    
                },{
                    "lookup": "combined_key",
                    "from": {
                        "data": {"url": "vegalite_files/data/resident_threatsx.csv"},
                        "key": "NRM_key",
                        "fields": ["NRM", "population", "total_interviewed", "threat", "threat_total"]
                    }
                },{
                    "calculate": "datum.threat_total/datum.total_interviewed",
                    "as": "threat_perc"
                },{
                    "calculate": "datum.total_interviewed < 10 ? 'Insufficient data' : format(datum.threat_perc, '.2%')",
                    "as": "tooltip_threat_perc"
                },{
                    "calculate": "datum.total_interviewed < 10 ? 'Insufficient data' : datum.threat_total",
                    "as": "tooltip_threat_total"
                }],
                "mark": {
                    "type": "geoshape", 
                    "stroke": "darkgray",
                    "opacity": 0.6
                },
                "encoding": {
                    "opacity": {
                    },
                    "color": {
                        "condition": {
                            "test": "datum.threat_perc == 0",
                            "value": "lightgrey"
                        },
                        "field": "threat_perc",
                        "type": "quantitative",
                        "scale": {
                            "domain": [0,0.45], "scheme": {"name": "reds"}
                        },
                    "legend": {
                        "title": "% of residents",
                        "format": ".0%"
                    }
                    },
                    "tooltip": [
                        {"field": "properties.NRM_REGION", "type": "nominal", "title": "NRM Region"},
                        {"field": "tooltip_threat_total", "title": "Num. interviewed residents concerned about threat"},
                        {"field": "tooltip_threat_perc", "title": "Perc. interviewed residents concerned about threat"}
                    ]
                }
            },{
            "data": {"values": {"state": "QUEENSLAND", "x": 146, "y": -27.5}},
            "mark": {"type": "text", "fontSize": 20, "color": "darkgray"},
            "encoding": {
                "text": {"field": "state", "type": "nominal"},
                "longitude": {"field": "x"}, 
                "latitude": {"field": "y"}}
            }
        ]
    }
    ]}]
    }, {
    "hconcat":[
    {
        "title": { "text": "Climate Change" },
        "height": 360,
        "data": {"url": "vegalite_files/data/resident_threatsx.csv"},
        "params": [{
            "name": "bar",
            "select": {
                "type": "point",
                "fields": ["NRM", "threat"]
            }
        }],
        "transform": [
            {"filter": "datum.NRM != 'Cape York'"},
            {"calculate": "datum.threat_total/datum.total_interviewed",
                "as": "threat_perc"}
        ],
        "mark": "bar",
        "encoding": {
            "column": {
                "field": "NRM", "type": "nominal", "header": {"labelOrient": "bottom", "title": null}
            },
            "x": {"field": "threat", "type": "nominal", "axis": null, "grid": null},
            "y": {"field": "threat_perc", "type": "quantitative", "grid": null, "axis": {"format": ".0%"}},
            "xOffset": {"field": "threat", "type": "nominal"},
            "color": {"field": "threat"},
            "opacity": {
                "condition": {
                    "test": "bar.empty || datum.threat == bar.threat && datum.NRM == bar.NRM",
                    "value": 1
                }, "value": 0.5
            }
        }

        }
    ]}
]
}